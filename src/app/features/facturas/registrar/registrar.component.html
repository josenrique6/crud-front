


<div class="container">
  <div class="row">
    <div class="col-md-12">
<!-- FILE: src/app/pages/invoices/registrar/registrar.component.html -->
<div class="invoice-wrapper card">
  <div class="card-body">
    <h5 class="mb-3">Registrar Factura</h5>

    <form [formGroup]="form" (ngSubmit)="submit()" novalidate>
      <!-- Cabecera -->
      <div class="row g-3">
        <div class="col-12 col-md-2">
          <label class="form-label"><small>Serie</small></label>
          <input class="form-control form-control-sm" formControlName="series" />
        </div>
        <div class="col-12 col-md-3">
          <label class="form-label"><small>Número</small></label>
          <input class="form-control form-control-sm" formControlName="number" />
        </div>
        <div class="col-12 col-md-3">
          <label class="form-label"><small>Fecha</small></label>
          <input type="date" class="form-control form-control-sm" formControlName="date" />
        </div>
        <div class="col-12 col-md-2">
          <label class="form-label"><small>Moneda</small></label>
          <select class="form-select form-select-sm" formControlName="currency">
            <option value="PEN">PEN</option>
            <option value="USD">USD</option>
          </select>
        </div>
      </div>

      <div class="row g-3 mt-1">
        <div class="col-12 col-md-3">
          <label class="form-label"><small>RUC/DNI</small></label>
          <input class="form-control form-control-sm" formControlName="customerRuc" />
        </div>
        <div class="col-12 col-md-5">
          <label class="form-label"><small>Razón Social / Nombre</small></label>
          <input class="form-control form-control-sm" formControlName="customerName" />
        </div>
      </div>

      <!-- Detalle -->
      <div class="d-flex align-items-center justify-content-between mt-4">
        <h6 class="mb-0">Detalles</h6>
        <button type="button" class="btn btn-sm btn-primary" (click)="openProductModal()">
          <i class="mdi mdi-plus me-1"></i> Agregar producto
        </button>
      </div>

      <div class="table-responsive mt-2">
        <table class="table table-sm align-middle">
          <thead class="table-light">
            <tr>
              <th style="width: 140px;">Código</th>
              <th>Producto</th>
              <th class="text-end" style="width: 120px;">Cantidad</th>
              <th class="text-end" style="width: 140px;">Precio</th>
              <th class="text-end" style="width: 140px;">Importe</th>
              <th style="width: 50px;"></th>
            </tr>
          </thead>
          <tbody formArrayName="details">
            <tr *ngFor="let row of details.controls; let i = index; trackBy: trackByIndex" [formGroupName]="i">
              <td>
                <input class="form-control form-control-sm" formControlName="productCode" readonly />
              </td>
              <td>
                <input class="form-control form-control-sm" formControlName="productName" readonly />
              </td>
              <td class="text-end">
                <input type="number" step="0.01" min="0.01"
                       class="form-control form-control-sm text-end"
                       formControlName="quantity"
                       (input)="onQtyPriceChange(row)" />
              </td>
              <td class="text-end">
                <input type="number" step="0.01" min="0"
                       class="form-control form-control-sm text-end"
                       formControlName="price"
                       (input)="onQtyPriceChange(row)" />
              </td>
              <td class="text-end">
                <input class="form-control form-control-sm text-end" formControlName="amount" readonly />
              </td>
              <td class="text-center">
                <button type="button" class="btn btn-sm btn-outline-danger" (click)="removeDetail(i)">
                  <i class="mdi mdi-trash-can-outline"></i>
                </button>
              </td>
            </tr>
            <tr *ngIf="details.length === 0">
              <td colspan="6" class="text-center text-muted py-3">
                No hay productos agregados.
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Totales -->
      <div class="row justify-content-end mt-3">
        <div class="col-12 col-md-4">
          <table class="table table-sm mb-0">
            <tbody>
            <tr>
              <th>Subtotal</th>
              <td class="text-end">{{ form.value.subtotal | number:'1.2-2' }}</td>
            </tr>
            <tr>
              <th>IGV (18%)</th>
              <td class="text-end">{{ form.value.tax | number:'1.2-2' }}</td>
            </tr>
            <tr class="table-light">
              <th>Total</th>
              <td class="text-end fw-bold">{{ form.value.total | number:'1.2-2' }}</td>
            </tr>
            </tbody>
          </table>
        </div>
      </div>

      <div class="d-flex gap-2 mt-3">
        <button type="submit" class="btn btn-success">
          <i class="mdi mdi-content-save-outline me-1"></i> Guardar
        </button>
        <button type="button" class="btn btn-outline-secondary" (click)="buildForm()">
          Limpiar
        </button>
        <!--Regresar-->
        <button type="button" class="btn btn-outline-primary" (click)="goBack()">
          <i class="mdi mdi-arrow-left me-1"></i> Regresar
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Modal de productos -->
<ng-template #productModal>
  <div class="modal-header py-2">
    <h2 class="modal-title">Seleccionar producto</h2>
    <button type="button" class="btn-close" aria-label="Close" (click)="closeModal()"></button>
  </div>
  <div class="modal-body">
    <div class="input-group input-group-sm mb-2">
      <span class="input-group-text"><i class="mdi mdi-magnify"></i></span>
      <input type="text" class="form-control" placeholder="Buscar por código o nombre" [formControl]="filter" />
    </div>
    <div class="table-responsive" style="max-height: 360px; overflow: auto;">
      <table class="table table-sm align-middle">
        <thead class="table-light">
          <tr>
            <th style="width: 120px;">Código ****</th>
            <th>Producto</th>
            <th class="text-end" style="width: 120px;">Precio</th>
            <th style="width: 80px;"></th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let p of filteredProducts()">
            <td>{{ p.code }}</td>
            <td>{{ p.name }}</td>
            <td class="text-end">{{ p.unitPrice | number:'1.2-2' }}</td>
            <td class="text-end">
              <button type="button" class="btn btn-sm btn-primary" (click)="selectProduct(p)">
                Elegir
              </button>
            </td>
          </tr>
          <tr *ngIf="filteredProducts().length === 0">
            <td colspan="4" class="text-center text-muted">Sin resultados</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</ng-template>
    </div>
  </div>
</div>